@page "/calendar"
@using System.Globalization
@inject HttpClient Http

<div class="calendar-wrapper">
    <h1 class="text-center my-4 text-2xl font-semibold">Bokningskalender</h1>

    <!-- Date/week header with responsive font size -->
    <div class="text-center text-sm sm:text-base font-semibold mb-4">
        <span>@StartOfWeek.ToString("yyyy-MM-dd") / Vecka @CurrentWeekNumber / @EndOfWeek.ToString("yyyy-MM-dd")</span>
    </div>

    <div class="overflow-x-auto">
        <div class="calendar-grid">
            <table class="table-auto border-collapse">
                <thead>
                    <tr>
                        <!-- Smaller font + padding on mobile for header column -->
                        <th class="border p-1 text-xs sm:text-sm md:text-base">Tid</th>
                        @foreach (var day in DaysOfWeek)
                        {
                            <!-- Smaller font + padding on mobile for weekday headers -->
                            <th class="border p-1 text-xs sm:text-sm md:text-base cursor-pointer hover:bg-gray-100" @onclick="() => OpenDay(day)">
                                @CapitalizeFirstLetter(day.ToString("ddd dd MMM", new CultureInfo("sv-SE")))
                            </th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var slot in TimeSlots)
                    {
                        <tr>
                            <td class="border p-2">@slot.Label</td>
                            @foreach (var day in DaysOfWeek)
                            {
                                var status = GetSlotStatus(day, slot.StartTime);

                                <!-- Dynamic width on mobile, no padding -->
                                <td class="aspect-square w-10 sm:w-12 md:w-14 border p-0 text-center hover:cursor-pointer"
                                    @onclick="() => BookSlot(day, slot.StartTime)"
                                    style="background-color:@GetColorForStatus(status)"
                                    title="@GetUsernameForSlot(day, slot.StartTime)">
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    private DateTime Today = DateTime.Today;
    private DateTime StartOfWeek;
    private DateTime EndOfWeek;
    private List<DateTime> DaysOfWeek = new();
    private List<TimeSlot> TimeSlots = new();
    private List<Booking> AllBookings = new();

protected override async Task OnInitializedAsync()
{
    CalculateWeek(Today);
    GenerateTimeSlots();
    AllBookings = await Http.GetFromJsonAsync<List<Booking>>("bookings") ?? new();
}

    private void CalculateWeek(DateTime referenceDate)
    {
        var diff = (7 + (referenceDate.DayOfWeek - DayOfWeek.Monday)) % 7;
        StartOfWeek = referenceDate.AddDays(-diff).Date;
        EndOfWeek = StartOfWeek.AddDays(6);
        DaysOfWeek = Enumerable.Range(0, 7).Select(i => StartOfWeek.AddDays(i)).ToList();
    }

    private void PreviousWeek()
    {
        Today = Today.AddDays(-7);
        CalculateWeek(Today);
    }

    private void NextWeek()
    {
        Today = Today.AddDays(7);
        CalculateWeek(Today);
    }

    private int CurrentWeekNumber
    {
        get
        {
            var ci = CultureInfo.CurrentCulture;
            return ci.Calendar.GetWeekOfYear(Today, CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday);
        }
    }

    private void GenerateTimeSlots()
    {
        TimeSlots.Clear();
        for (int hour = 11; hour < 23; hour++)
        {
            var slot = new TimeSlot
            {
                Label = $"{hour:00}-{(hour + 1) % 24:00}",
                StartTime = TimeSpan.FromHours(hour)
            };
            TimeSlots.Add(slot);
        }
    }

    private string? GetUsernameForSlot(DateTime day, TimeSpan time)
    {
        var booking = AllBookings.FirstOrDefault(b => b.Date.Date == day.Date && b.StartTime == time);
        return booking != null && booking.Type != "Free" ? booking.Username : null;
    }

    private string GetSlotStatus(DateTime day, TimeSpan time)
    {
        var booking = AllBookings.FirstOrDefault(b => b.Date.Date == day.Date && b.StartTime == time);
        return booking?.Type ?? "Free";  // falls back to "Free" if not found
    }

    private string GetColorForStatus(string status) => status switch
    {
        "Free" => "#228B22",   // Forest Green
        "Private" => "#f08080", // Light red
        "Open" => "#add8e6",    // Light blue
        "Blocked" => "#d3d3d3", // Light gray
        _ => "white"
    };

    private void OpenDay(DateTime day)
    {
        // TODO: Navigate to day view later
        Console.WriteLine($"Clicked on {day.ToShortDateString()}");
    }

    private async Task BookSlot(DateTime day, TimeSpan time)
    {
        var username = await JS.InvokeAsync<string>("localStorage.getItem", "username");
        if (string.IsNullOrWhiteSpace(username))
        {
            Console.WriteLine("User not logged in. Booking is not allowed.");
            return; // Exit early if not logged in
        }

        var newBooking = new Booking
        {
            Date = day,
            StartTime = time,
            Username = username,
            Type = "Private" // TEMP: always book private
        };

        var response = await Http.PostAsJsonAsync("bookings", newBooking);
        if (response.IsSuccessStatusCode)
        {
            AllBookings.Add(newBooking);
            StateHasChanged();
        }
    }

    public class TimeSlot
    {
        public string Label { get; set; } = "";
        public TimeSpan StartTime { get; set; }
    }

    private string CapitalizeFirstLetter(string input)
    {
        return string.IsNullOrEmpty(input) ? input : char.ToUpper(input[0]) + input.Substring(1);
    }

    public class Booking
    {
        public DateTime Date { get; set; }
        public TimeSpan StartTime { get; set; }
        public string Username { get; set; } = "";
        public string Type { get; set; } = "Private"; // ‚Üê "Private", "Open", "Blocked"
    }
}