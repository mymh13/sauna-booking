@inject IJSRuntime JS
@inject NavigationManager Navigation

<nav class="nav-menu">
    <div class="nav-container">
        <!-- Desktop links -->
        <div class="nav-left desktop-only">
            <NavLink href="calendar" class="nav-link uppercase" Match="NavLinkMatch.All">Kalender</NavLink>
            <NavLink href="dashboard" class="nav-link uppercase" Match="NavLinkMatch.All">Dashboard</NavLink>
        </div>

        <!-- Mobile hamburger -->
        <div class="mobile-only w-full">
            <button class="nav-button" @onclick="ToggleMobileMenu">☰ Meny</button>
            @if (ShowMobileMenu)
            {
                <div class="mobile-menu">
                    <NavLink href="calendar" class="nav-link uppercase block">Kalender</NavLink>
                    <NavLink href="dashboard" class="nav-link uppercase block">Dashboard</NavLink>
                </div>
            }
        </div>

        <div class="nav-center">
            @if (!string.IsNullOrEmpty(LoggedInUsername))
            {
                <span class="nav-user">Inloggad som: @LoggedInUsername</span>
            }
        </div>

        <div class="nav-right">
            @if (!string.IsNullOrEmpty(LoggedInUsername))
            {
                <button class="nav-button" @onclick="Logout">Logga ut</button>
            }
            <button class="nav-button" @onclick="ToggleTheme">@CurrentThemeLabel</button>
        </div>
    </div>
</nav>

@code {
    private string? LoggedInUsername;
    private string CurrentThemeLabel = "Mörkt läge";
    private bool ShowMobileMenu = false;

    protected override async Task OnInitializedAsync()
    {
        LoggedInUsername = await JS.InvokeAsync<string>("localStorage.getItem", "username");

        var theme = await JS.InvokeAsync<string>("localStorage.getItem", "theme");
        CurrentThemeLabel = theme == "light" ? "Mörkt läge" : "Ljust läge";
    }

    private async Task Logout()
    {
        await JS.InvokeVoidAsync("localStorage.removeItem", "username");
        await JS.InvokeVoidAsync("localStorage.removeItem", "role");
        LoggedInUsername = null;
        Navigation.NavigateTo("/sauna/");
    }

    private async Task ToggleTheme()
    {
        var currentTheme = await JS.InvokeAsync<string>("localStorage.getItem", "theme");
        if (currentTheme == "light")
        {
            await JS.InvokeVoidAsync("localStorage.setItem", "theme", "dark");
            CurrentThemeLabel = "Ljust läge";
        }
        else
        {
            await JS.InvokeVoidAsync("localStorage.setItem", "theme", "light");
            CurrentThemeLabel = "Mörkt läge";
        }

        await JS.InvokeVoidAsync("location.reload");
    }

    private void ToggleMobileMenu()
    {
        ShowMobileMenu = !ShowMobileMenu;
    }
}